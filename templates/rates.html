<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Tax Rates - CactusComply</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <style>
      .navbar-brand {
        font-weight: bold;
        color: #007bff !important;
      }
      .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
      }
      .rate-badge {
        font-size: 0.875em;
        padding: 0.25em 0.5em;
      }
      .table-responsive {
        max-height: 600px;
        overflow-y: auto;
      }
      .filter-section {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      .dataTables_wrapper .dataTables_paginate {
        float: right;
        text-align: right;
        padding-top: 0.25em;
      }
      .dataTables_wrapper .dataTables_paginate .paginate_button {
        box-sizing: border-box;
        display: inline-block;
        min-width: 1.5em;
        padding: 0.5em 1em;
        margin-left: 2px;
        text-align: center;
        text-decoration: none !important;
        cursor: pointer;
        border: 1px solid transparent;
        border-radius: 2px;
        background: transparent;
        color: #333 !important;
      }
      .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: #007bff !important;
        border-color: #007bff !important;
        color: white !important;
      }
      .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: #0056b3 !important;
        border-color: #0056b3 !important;
        color: white !important;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('index') }}">
          <i class="fas fa-chart-line me-2"></i>Tax Rates Intake
        </a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="{{ url_for('index') }}">
            <i class="fas fa-upload me-1"></i>Upload
          </a>
          <a class="nav-link active" href="{{ url_for('view_rates') }}">
            <i class="fas fa-table me-1"></i>View Rates
          </a>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h4 class="mb-0">
                <i class="fas fa-table me-2"></i>Arizona TPT Tax Rates
              </h4>
              <div class="btn-group" role="group">
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm"
                  onclick="exportToCSV()"
                >
                  <i class="fas fa-download me-1"></i>Export CSV
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  onclick="refreshData()"
                >
                  <i class="fas fa-sync me-1"></i>Refresh
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="filter-section">
                <div class="row">
                  <div class="col-md-3">
                    <label for="businessFilter" class="form-label"
                      >Business Code:</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="businessFilter"
                      placeholder="Filter by business code..."
                      onkeyup="filterTable()"
                    />
                  </div>
                  <div class="col-md-3">
                    <label for="jurisdictionFilter" class="form-label"
                      >City Code:</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="jurisdictionFilter"
                      placeholder="Filter by city code..."
                      onkeyup="filterTable()"
                    />
                  </div>
                  <div class="col-md-3">
                    <label for="rateFilter" class="form-label"
                      >Min Total Rate:</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="rateFilter"
                      step="0.0001"
                      placeholder="0.0000"
                      onkeyup="filterTable()"
                    />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm"
                        onclick="clearFilters()"
                      >
                        <i class="fas fa-times me-1"></i>Clear Filters
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-striped table-hover" id="ratesTable">
                  <thead class="table-dark">
                    <tr>
                      <th>ID</th>
                      <th>Business Code</th>
                      <th>Business Description</th>
                      <th>City Code</th>
                      <th>City Name</th>
                      <th>State Rate</th>
                      <th>County Rate</th>
                      <th>City Rate</th>
                      <th>Total Rate</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for rate in rates %}
                    <tr>
                      <td>
                        <span class="badge bg-secondary">{{ rate.id }}</span>
                      </td>
                      <td>
                        <strong>{{ rate.business_code }}</strong>
                      </td>
                      <td>
                        {{ rate.business_class_codes.description if
                        rate.business_class_codes else 'N/A' }}
                      </td>
                      <td>
                        <span class="badge bg-primary"
                          >{{ rate.jurisdictions.city_code if rate.jurisdictions
                          else 'N/A' }}</span
                        >
                      </td>
                      <td>
                        {{ rate.jurisdictions.city_name if rate.jurisdictions
                        else 'N/A' }}
                      </td>
                      <td>
                        <span class="badge bg-info rate-badge"
                          >{{ "%.4f"|format(rate.state_rate) }}</span
                        >
                      </td>
                      <td>
                        <span class="badge bg-warning rate-badge"
                          >{{ "%.4f"|format(rate.county_rate) }}</span
                        >
                      </td>
                      <td>
                        <span class="badge bg-success rate-badge"
                          >{{ "%.4f"|format(rate.city_rate) }}</span
                        >
                      </td>
                      <td>
                        <strong class="text-primary"
                          >{{ "%.4f"|format(rate.total_rate) }}</strong
                        >
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              {% if not rates %}
              <div class="text-center py-5">
                <i class="fas fa-table fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No tax rates found</h5>
                <p class="text-muted">Upload a CSV file to get started</p>
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                  <i class="fas fa-upload me-2"></i>Upload CSV
                </a>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
      let table;

      $(document).ready(function () {
        table = $("#ratesTable").DataTable({
          pageLength: 25,
          lengthMenu: [
            [10, 25, 50, 100, -1],
            [10, 25, 50, 100, "All"],
          ],
          order: [[0, "asc"]], // Sort by ID ascending
          columnDefs: [
            { targets: [5, 6, 7, 8], type: "num" }, // Numeric columns for rates
            { targets: [0], type: "num" }, // Numeric columns for IDs
          ],
          language: {
            search: "Search all columns:",
            lengthMenu: "Show _MENU_ records per page",
            info: "Showing _START_ to _END_ of _TOTAL_ records",
            infoEmpty: "No records found",
            infoFiltered: "(filtered from _MAX_ total records)",
            paginate: {
              first: "First",
              last: "Last",
              next: "Next",
              previous: "Previous",
            },
          },
          dom:
            '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
            '<"row"<"col-sm-12"tr>>' +
            '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
          responsive: true,
        });
      });

      function filterTable() {
        // Check if table is initialized
        if (!table) {
          console.error("DataTable not initialized");
          return;
        }

        const businessFilter = document
          .getElementById("businessFilter")
          .value.toLowerCase();
        const jurisdictionFilter = document
          .getElementById("jurisdictionFilter")
          .value.toLowerCase();
        const rateFilter =
          parseFloat(document.getElementById("rateFilter").value) || 0;

        // Clear all existing filters
        table.search("").columns().search("").draw();

        // Apply filters one by one
        if (businessFilter) {
          table.column(1).search(businessFilter);
        }

        if (jurisdictionFilter) {
          table.column(3).search(jurisdictionFilter);
        }

        // Apply rate filter using custom search
        if (rateFilter > 0) {
          $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
            const totalRate = parseFloat(data[8]) || 0;
            return totalRate >= rateFilter;
          });
        }

        table.draw();

        // Clean up custom filters
        $.fn.dataTable.ext.search.pop();
      }

      function exportToCSV() {
        const data = table.rows({ search: "applied" }).data();
        let csv =
          "ID,Business Code,Business Description,City Code,City Name,State Rate,County Rate,City Rate,Total Rate\n";

        data.each(function (row) {
          csv += row.join(",") + "\n";
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download =
          "tax_rates_" + new Date().toISOString().split("T")[0] + ".csv";
        a.click();
        window.URL.revokeObjectURL(url);
      }

      function refreshData() {
        location.reload();
      }

      // Clear filters
      function clearFilters() {
        // Check if table is initialized
        if (!table) {
          console.error("DataTable not initialized");
          return;
        }

        document.getElementById("businessFilter").value = "";
        document.getElementById("jurisdictionFilter").value = "";
        document.getElementById("rateFilter").value = "";

        // Clear all filters
        table.search("").columns().search("").draw();
      }
    </script>
  </body>
</html>
